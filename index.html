<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î - BIGIT CRM</title>
  <link rel="icon" type="image/png" href="https://crm.bigitcorp.co.th/images/logo-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <div class="page-wrapper">
    <!-- Header -->
    <header class="header"></header>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <!-- Page Header -->
        <div style="margin-bottom: var(--spacing-xl);">
          <h1>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h1>
          <p class="text-muted">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå</p>
        </div>

        <!-- Quick Actions -->
        <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-xl); flex-wrap: wrap;">
          <a href="tasks.html" class="btn btn-primary">
            ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
          </a>
          <a href="projects.html" class="btn btn-secondary">
            üìÅ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà
          </a>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid" id="statsGrid"></div>

        <!-- Recent Activities & Upcoming Reminders -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-xl); margin-top: var(--spacing-xl);">
          <!-- Recent Activities -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">üìú ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
              <a href="logs.html" class="btn btn-sm btn-outline">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
            </div>
            <div class="card-body">
              <div id="recentActivities"></div>
            </div>
          </div>

          <!-- Upcoming Tasks -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">üìÖ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î</h3>
              <a href="tasks.html" class="btn btn-sm btn-outline">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
            </div>
            <div class="card-body">
              <div id="upcomingTasks"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="assets/js/app.js"></script>
  <script src="assets/js/tasks.js"></script>
  <script src="assets/js/projects.js"></script>
  <script>
    // Render Dashboard
    function renderDashboard() {
      renderStats();
      renderRecentActivities();
      renderUpcomingTasks();
    }

    function renderStats() {
      const tasks = getTasks();
      const projects = getProjects();
      const notifications = getNotifications();

      const todoCount = tasks.filter(t => t.status === 'todo').length;
      const inProgressCount = tasks.filter(t => t.status === 'inprogress').length;
      const doneCount = tasks.filter(t => t.status === 'done').length;
      const unreadNotifs = notifications.filter(n => !n.read && !n.deleted).length;

      const statsGrid = document.getElementById('statsGrid');
      statsGrid.innerHTML = `
        <div class="stat-card">
          <div class="stat-icon" style="background: var(--color-primary-light); color: var(--color-primary);">
            üìÅ
          </div>
          <div class="stat-content">
            <div class="stat-label">‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="stat-value">${projects.length}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: var(--color-todo-light); color: var(--color-todo);">
            üìã
          </div>
          <div class="stat-content">
            <div class="stat-label">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</div>
            <div class="stat-value">${todoCount}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: var(--color-inprogress-light); color: var(--color-inprogress);">
            ‚ö°
          </div>
          <div class="stat-content">
            <div class="stat-label">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</div>
            <div class="stat-value">${inProgressCount}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: var(--color-done-light); color: var(--color-done);">
            ‚úÖ
          </div>
          <div class="stat-content">
            <div class="stat-label">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
            <div class="stat-value">${doneCount}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: var(--color-danger-light); color: var(--color-danger);">
            üîî
          </div>
          <div class="stat-content">
            <div class="stat-label">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
            <div class="stat-value">${unreadNotifs}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: #fef3c7; color: var(--color-warning);">
            üìä
          </div>
          <div class="stat-content">
            <div class="stat-label">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="stat-value">${tasks.length}</div>
          </div>
        </div>
      `;
    }

    function renderRecentActivities() {
      const logs = getLogs();
      const recentLogs = logs.slice(0, 5);

      const container = document.getElementById('recentActivities');

      if (recentLogs.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>';
        return;
      }

      container.innerHTML = `
        <div class="timeline">
          ${recentLogs.map(log => {
            const typeIcons = {
              auth: 'üîê',
              task: 'üìã',
              project: 'üìÅ',
              comment: 'üí¨',
              checklist: '‚òëÔ∏è',
              notification: 'üîî',
              settings: '‚öôÔ∏è'
            };
            
            return `
              <div class="timeline-item">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                  <div class="timeline-title">
                    ${typeIcons[log.type] || 'üìù'} ${log.action}
                  </div>
                  <div class="timeline-description">
                    ${log.description}
                  </div>
                  <div class="timeline-time">
                    ${formatRelativeTime(log.timestamp)}
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function renderUpcomingTasks() {
      const tasks = getTasks();
      const now = new Date();
      
      // Get tasks with due dates in the next 7 days
      const upcomingTasks = tasks
        .filter(t => t.dueDate && t.status !== 'done')
        .map(t => ({
          ...t,
          dueDateTime: new Date(t.dueDate)
        }))
        .filter(t => t.dueDateTime >= now)
        .sort((a, b) => a.dueDateTime - b.dueDateTime)
        .slice(0, 5);

      const container = document.getElementById('upcomingTasks');

      if (upcomingTasks.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>';
        return;
      }

      container.innerHTML = upcomingTasks.map(task => {
        const project = task.projectId ? getProjectById(task.projectId) : null;
        const daysUntilDue = Math.ceil((task.dueDateTime - now) / (1000 * 60 * 60 * 24));
        
        return `
          <div style="padding: var(--spacing-md); border-bottom: 1px solid var(--color-gray-100); cursor: pointer;" onclick="window.location.href='task-detail.html?id=${task.id}'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-xs);">
              <strong>${task.title}</strong>
              <span class="badge badge-${task.status === 'todo' ? 'todo' : 'inprogress'}">
                ${task.status === 'todo' ? '‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥'}
              </span>
            </div>
            <div class="text-muted" style="font-size: 0.875rem;">
              ${project ? `üìÅ ${project.name} ‚Ä¢ ` : ''}
              üìÖ ${formatDate(task.dueDate)}
              ${daysUntilDue <= 3 ? `<span style="color: var(--color-danger); font-weight: 600;"> (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysUntilDue} ‡∏ß‡∏±‡∏ô)</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // Initialize dashboard
    checkUpcomingTaskNotifications(); // Check and create notifications for upcoming tasks
    renderDashboard();
  </script>
</body>
</html>
