<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô - BIGIT CRM</title>
  <link rel="icon" type="image/png" href="https://crm.bigitcorp.co.th/images/logo-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <div class="page-wrapper">
    <!-- Header -->
    <header class="header"></header>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <!-- Back Button -->
        <div style="margin-bottom: var(--spacing-lg);">
          <a href="tasks.html" class="btn btn-outline">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
        </div>

        <div id="taskDetailContainer"></div>
      </div>
    </main>
  </div>

  <!-- Add Checklist Modal -->
  <div class="modal" id="checklistModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h2>
        <button class="modal-close" onclick="closeModal('checklistModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
          <input type="text" class="form-control" id="checklistItemText" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('checklistModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn btn-primary" onclick="saveChecklistItem()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      </div>
    </div>
  </div>

  <!-- Reminder Modal -->
  <div class="modal" id="reminderModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h2>
        <button class="modal-close" onclick="closeModal('reminderModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</label>
          <input type="date" class="form-control" id="reminderDate">
        </div>
        <div class="form-group">
          <label class="form-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
          <textarea class="form-control" id="reminderMessage" rows="3" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('reminderModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn btn-primary" onclick="saveReminder()">‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
      </div>
    </div>
  </div>

  <script src="assets/js/app.js"></script>
  <script src="assets/js/projects.js"></script>
  <script src="assets/js/tasks.js"></script>
  <script src="assets/js/notifications.js"></script>
  <script>
    let currentTaskId = null;

    // Initialize
    function initTaskDetail() {
      const urlParams = new URLSearchParams(window.location.search);
      currentTaskId = urlParams.get('id');

      if (!currentTaskId) {
        window.location.href = 'tasks.html';
        return;
      }

      renderTaskDetail();
    }

    function renderTaskDetail() {
      const task = getTaskById(currentTaskId);
      
      if (!task) {
        document.getElementById('taskDetailContainer').innerHTML = `
          <div class="card">
            <div class="card-body text-center">
              <h2>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô</h2>
              <p class="text-muted">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
              <a href="tasks.html" class="btn btn-primary">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
            </div>
          </div>
        `;
        return;
      }

      const project = task.projectId ? getProjectById(task.projectId) : null;
      const assignee = task.assignee ? getUserById(task.assignee) : null;
      const manager = task.manager ? getUserById(task.manager) : null;

      const statusBadges = {
        todo: '<span class="badge badge-todo">‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</span>',
        inprogress: '<span class="badge badge-inprogress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</span>',
        done: '<span class="badge badge-done">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>'
      };

      const priorityBadges = {
        low: '<span class="badge badge-priority-low">‡∏ï‡πà‡∏≥</span>',
        medium: '<span class="badge badge-priority-medium">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</span>',
        high: '<span class="badge badge-priority-high">‡∏™‡∏π‡∏á</span>'
      };

      const completedChecklist = task.checklist.filter(i => i.completed).length;
      const totalChecklist = task.checklist.length;

      document.getElementById('taskDetailContainer').innerHTML = `
        <!-- Task Info Card -->
        <div class="card mb-3">
          <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div style="flex: 1;">
                <h2 class="card-title">${task.title}</h2>
                <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-sm);">
                  ${statusBadges[task.status]}
                  ${priorityBadges[task.priority]}
                </div>
              </div>
              <div style="display: flex; gap: var(--spacing-sm);">
                <button class="btn btn-primary" onclick="openEditTaskModal('${task.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="btn btn-outline" onclick="openReminderModal()">üîî ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
                <button class="btn btn-danger" onclick="confirmDeleteTask('${task.id}')">üóëÔ∏è ‡∏•‡∏ö</button>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
              ${project ? `
                <div>
                  <div class="text-muted" style="font-size: 0.875rem; margin-bottom: var(--spacing-xs);">üìÅ ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå</div>
                  <div><strong>${project.name}</strong></div>
                </div>
              ` : ''}
              ${assignee ? `
                <div>
                  <div class="text-muted" style="font-size: 0.875rem; margin-bottom: var(--spacing-xs);">üë§ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</div>
                  <div><strong>${assignee.name}</strong></div>
                </div>
              ` : ''}
              ${manager ? `
                <div>
                  <div class="text-muted" style="font-size: 0.875rem; margin-bottom: var(--spacing-xs);">üëî ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>
                  <div><strong>${manager.name}</strong></div>
                </div>
              ` : ''}
              ${task.dueDate ? `
                <div>
                  <div class="text-muted" style="font-size: 0.875rem; margin-bottom: var(--spacing-xs);">üìÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</div>
                  <div><strong>${formatDate(task.dueDate)}</strong></div>
                </div>
              ` : ''}
              <div>
                <div class="text-muted" style="font-size: 0.875rem; margin-bottom: var(--spacing-xs);">üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</div>
                <div><strong>${formatDate(task.createdAt)}</strong></div>
              </div>
            </div>

            ${task.description ? `
              <div>
                <h3 style="font-size: 1.125rem; margin-bottom: var(--spacing-md);">üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
                <p style="white-space: pre-wrap; line-height: 1.6;">${task.description}</p>
              </div>
            ` : ''}
          </div>
        </div>

        <!-- Checklist Card -->
        <div class="card mb-3">
          <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 class="card-title">
                ‚òëÔ∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                ${totalChecklist > 0 ? `<span class="badge badge-${completedChecklist === totalChecklist ? 'done' : 'inprogress'}">${completedChecklist}/${totalChecklist}</span>` : ''}
              </h3>
              <button class="btn btn-sm btn-primary" onclick="openChecklistModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            </div>
          </div>
          <div class="card-body">
            <div id="checklistContainer">
              ${task.checklist.length === 0 ? '<p class="text-muted text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>' : renderChecklist(task)}
            </div>
          </div>
        </div>

        <!-- Comments Card -->
        <div class="card mb-3">
          <div class="card-header">
            <h3 class="card-title">üí¨ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</h3>
          </div>
          <div class="card-body">
            <div id="commentsContainer">
              ${renderComments(task)}
            </div>
            <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-sm);">
              <input type="text" class="form-control" id="newComment" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô...">
              <button class="btn btn-primary" onclick="addComment()">‡∏™‡πà‡∏á</button>
            </div>
          </div>
        </div>

        <!-- Activity Timeline Card -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìú ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
          </div>
          <div class="card-body">
            ${renderTaskTimeline(task)}
          </div>
        </div>
      `;
    }

    function renderChecklist(task) {
      if (!task.checklist || task.checklist.length === 0) {
        return '<p class="text-muted text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>';
      }

      return `
        <div class="checklist">
          ${task.checklist.map(item => `
            <div class="checklist-item">
              <input 
                type="checkbox" 
                class="checklist-checkbox"
                ${item.completed ? 'checked' : ''}
                onchange="toggleChecklistItem('${task.id}', '${item.id}')"
              >
              <div class="checklist-content">
                <div class="checklist-text ${item.completed ? 'completed' : ''}" id="checklist-text-${item.id}">
                  ${item.text}
                </div>
                <div style="margin-top: var(--spacing-sm); display: flex; gap: var(--spacing-sm);">
                  <button class="btn btn-sm btn-outline" onclick="editChecklistItem('${item.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                  <button class="btn btn-sm btn-outline" onclick="toggleChecklistComments('${item.id}')">üí¨ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (${item.comments?.length || 0})</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteChecklistItemConfirm('${task.id}', '${item.id}')">‡∏•‡∏ö</button>
                </div>
                <div class="checklist-comments" id="checklist-comments-${item.id}" style="display: none;">
                  ${renderChecklistComments(item)}
                  <div style="margin-top: var(--spacing-sm); display: flex; gap: var(--spacing-sm);">
                    <input type="text" class="form-control" id="checklist-comment-${item.id}" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô...">
                    <button class="btn btn-sm btn-primary" onclick="addChecklistCommentBtn('${task.id}', '${item.id}')">‡∏™‡πà‡∏á</button>
                  </div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderChecklistComments(item) {
      if (!item.comments || item.comments.length === 0) {
        return '<p class="text-muted" style="font-size: 0.875rem;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</p>';
      }

      return item.comments.map(comment => `
        <div class="comment">
          <div class="comment-author">${comment.userName}</div>
          <div class="comment-text">${comment.text}</div>
          <div class="comment-time">${formatRelativeTime(comment.createdAt)}</div>
        </div>
      `).join('');
    }

    function renderComments(task) {
      if (!task.comments || task.comments.length === 0) {
        return '<p class="text-muted text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</p>';
      }

      return task.comments.map(comment => `
        <div class="comment" style="margin-bottom: var(--spacing-md);">
          <div class="comment-author">${comment.userName}</div>
          <div class="comment-text">${comment.text}</div>
          <div class="comment-time">${formatRelativeTime(comment.createdAt)}</div>
        </div>
      `).join('');
    }

    function renderTaskTimeline(task) {
      const logs = getLogs().filter(log => log.metadata?.taskId === task.id);

      if (logs.length === 0) {
        return '<p class="text-muted text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>';
      }

      return `
        <div class="timeline">
          ${logs.map(log => `
            <div class="timeline-item">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <div class="timeline-title">${log.action}</div>
                <div class="timeline-description">${log.description}</div>
                <div class="timeline-time">${formatRelativeTime(log.timestamp)}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Checklist functions
    function openChecklistModal() {
      document.getElementById('checklistItemText').value = '';
      openModal('checklistModal');
    }

    function saveChecklistItem() {
      const itemText = document.getElementById('checklistItemText').value.trim();
      
      if (!itemText) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
        return;
      }

      addChecklistItem(currentTaskId, itemText);
      closeModal('checklistModal');
      renderTaskDetail();
      showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
    }

    function toggleChecklistItemFn(taskId, itemId) {
      toggleChecklistItem(taskId, itemId);
      renderTaskDetail();
    }

    function editChecklistItem(itemId) {
      const textElement = document.getElementById(`checklist-text-${itemId}`);
      const currentText = textElement.textContent.trim();
      
      const newText = prompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:', currentText);
      
      if (newText && newText !== currentText) {
        updateChecklistItem(currentTaskId, itemId, newText);
        renderTaskDetail();
        showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
      }
    }

    function deleteChecklistItemConfirm(taskId, itemId) {
      if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) {
        deleteChecklistItem(taskId, itemId);
        renderTaskDetail();
        showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
      }
    }

    function toggleChecklistComments(itemId) {
      const commentsDiv = document.getElementById(`checklist-comments-${itemId}`);
      commentsDiv.style.display = commentsDiv.style.display === 'none' ? 'block' : 'none';
    }

    function addChecklistCommentBtn(taskId, itemId) {
      const input = document.getElementById(`checklist-comment-${itemId}`);
      const commentText = input.value.trim();
      
      if (!commentText) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô', 'error');
        return;
      }

      addChecklistComment(taskId, itemId, commentText);
      input.value = '';
      renderTaskDetail();
      showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
    }

    // Comment functions
    function addComment() {
      const input = document.getElementById('newComment');
      const commentText = input.value.trim();
      
      if (!commentText) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô', 'error');
        return;
      }

      addTaskComment(currentTaskId, commentText);
      input.value = '';
      renderTaskDetail();
      showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
    }

    // Reminder functions
    function openReminderModal() {
      const task = getTaskById(currentTaskId);
      if (task.dueDate) {
        document.getElementById('reminderDate').value = task.dueDate;
      }
      openModal('reminderModal');
    }

    function saveReminder() {
      const reminderDate = document.getElementById('reminderDate').value;
      const reminderMessage = document.getElementById('reminderMessage').value.trim();
      
      if (!reminderDate) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', 'error');
        return;
      }

      createReminder(currentTaskId, reminderDate, reminderMessage);
      closeModal('reminderModal');
    }

    // Initialize
    initTaskDetail();
  </script>
</body>
</html>
